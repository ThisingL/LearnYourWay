# 环境与项目初始化（Python 后端）

本项目当前阶段专注**后端 API 开发**，以 Python + FastAPI 为主，队列用 Celery（Redis/RabbitMQ），HTTP 调用用 httpx，重试用 tenacity/backoff；不引入 LangChain，先以"轻封装 + 明确契约"实现可控、可测试的最小可用链路。

## 技术选型与原则
- 后端：Python 3.11 + FastAPI + Uvicorn/Gunicorn
- 任务队列：Celery + Redis/RabbitMQ（解析/生成/评测等耗时任务）
- 网络/重试：httpx + tenacity/backoff（超时、重试、退避、速率限制）
- 数据校验：Pydantic（结构化出入参）
- 向量库（起步→进阶）：pgvector → Qdrant Cloud（或 MongoDB Atlas Vector）
- 模型调用：优先托管 API（OpenAI/Anthropic/Gemini/国内可替换）；嵌入用 `text-embedding-3-large/-small`
- 抽象层：自定义 `LLMProvider`（`complete/chat/embed`）与 `VectorStoreRepository`，保留后续平滑迁移空间
- 不使用：LangChain（当前阶段），等 RAG/工具链复杂后再择机按需引入模块

## 后端初始化（Python + FastAPI）
- 依赖安装（示例）：
```bash
python -m venv .venv && source .venv/bin/activate
pip install --upgrade pip
pip install fastapi uvicorn[standard] pydantic-settings httpx tenacity backoff
pip install celery[redis] redis # 或 rabbitmq: pip install celery
pip install orjson python-dotenv
pip install pytest pytest-asyncio httpx[http2]
# 可选观测：
pip install opentelemetry-sdk opentelemetry-instrumentation-fastapi opentelemetry-exporter-otlp
```

- 目录结构建议：
```
server/
  app/
    main.py              # FastAPI 入口
    api/                 # 路由层（ingest/personalize/materials/...）
    services/
      llm_provider.py    # LLMProvider 接口与多厂商实现
      embedder.py        # 嵌入封装
      rag.py             # 可选 RAG 检索
    tasks/
      worker.py          # Celery 实例
      ingest_pdf.py      # 解析任务
      personalize.py     # 个性化改写任务
      materials.py       # 素材生成任务
      scoring.py         # 评测任务
    models/              # Pydantic 模型
    repos/               # VectorStoreRepository/DB 访问
    config.py            # 设置/环境变量
  tests/
```

## 环境变量（.env.example）
```
# LLM 相关
LLM_PROVIDER=openai           # openai|anthropic|google|qwen ...
LLM_MODEL=gpt-4o-mini         # 主模型
EMBEDDING_MODEL=text-embedding-3-large
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
GOOGLE_API_KEY=
QWEN_API_KEY=

# 队列与存储
REDIS_URL=redis://localhost:6379/0   # 或 RABBITMQ_URL=amqp://...
DB_URL=postgresql://user:pass@host:5432/db
VECTOR_DB=pgvector                   # pgvector|qdrant|mongodb
PG_DSN=postgresql://user:pass@host:5432/db
QDRANT_URL=
QDRANT_API_KEY=
MONGODB_URI=
MONGODB_DB=

# 其他
MODEL_SERVE_MODE=api    # api|local，已确定使用 api
RATE_LIMIT_RPS=1
LOG_LEVEL=INFO
```

## 运行与测试（后端）
```bash
# 开发启动
uvicorn app.main:app --reload
# 启动 Celery worker
celery -A app.tasks.worker worker -l info
# 测试
pytest -q
```

## API 演示工具准备
- **Postman/Insomnia**：用于 API 测试与演示
- **Swagger UI**：FastAPI 自带，访问 `/docs` 即可
- **可选简单前端**（如需演示界面）：
  - 单页 HTML + Vanilla JS/Vue/React
  - 仅用于演示核心流程，不做复杂交互
  
```bash
# 创建简单的演示页面目录（可选）
mkdir -p demo
# 可放置静态 HTML 文件用于演示
```

## 持续集成（要点）
- **后端测试**（重点）：
  - `pytest` + 覆盖率门槛（推荐 >80%）
  - 契约测试（OpenAPI 规范验证）
  - 性能测试（响应时间 < 2s）
- **质量门禁**：
  - 固定评测基准（个性化/测验/导图）与分数阈值
  - API 响应格式校验
  - 构建 Docker 镜像并部署测试环境

