# 测试策略（后端为主）

目标：确保后端 API 功能正确、稳定、高性能。当前阶段专注后端测试，暂不开发移动端应用。

## 任务清单
1. 单元测试：核心业务逻辑测试
2. 集成测试：API 端到端流程测试
3. 契约测试：API 规范一致性验证
4. 性能测试：负载与响应时间
5. API 文档与演示

## 后端测试实现

### 1) 单元测试（pytest）
```bash
# 测试结构
tests/
  unit/
    test_pdf_parser.py       # PDF 解析逻辑
    test_personalize.py      # 个性化改写
    test_materials.py        # 素材生成
    test_llm_provider.py     # LLM 调用封装
  integration/
    test_ingest_flow.py      # 完整摄取流程
    test_personalize_flow.py # 个性化流程
    test_materials_flow.py   # 素材生成流程
  fixtures/
    sample.pdf
    expected_outputs.json

# 运行测试
pytest tests/unit -v --cov=app --cov-report=html
pytest tests/integration -v
```

### 2) API 契约测试
```python
# 使用 schemathesis 自动测试 OpenAPI 规范
import schemathesis

schema = schemathesis.from_uri("http://localhost:8000/openapi.json")

@schema.parametrize()
def test_api_contract(case):
    case.call_and_validate()
```

### 3) 性能测试（k6/locust）
```javascript
// k6 脚本示例
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  vus: 10,
  duration: '30s',
};

export default function () {
  let res = http.get('http://localhost:8000/profiles/demo_user');
  check(res, { 'status is 200': (r) => r.status === 200 });
}
```

### 4) E2E 测试（完整流程）
```python
# tests/e2e/test_full_workflow.py
def test_complete_workflow():
    # 1. 上传 PDF
    response = client.post("/ingest/pdf", files={"file": open("sample.pdf", "rb")})
    task_id = response.json()["data"]["taskId"]
    
    # 2. 轮询直到完成
    while True:
        status = client.get(f"/ingest/tasks/{task_id}").json()
        if status["data"]["status"] == "SUCCESS":
            break
        time.sleep(1)
    
    # 3. 创建画像
    profile = client.post("/profiles", json={
        "userId": "test_user",
        "grade": 5,
        "interests": ["足球", "科学"]
    }).json()
    
    # 4. 生成个性化内容
    # 5. 生成学习素材
    # ...
```

## API 文档与演示

### Swagger UI
- 自动生成：访问 `http://localhost:8000/docs`
- 支持在线测试所有接口
- 包含请求/响应示例

### Postman Collection
```json
{
  "info": {
    "name": "LearnYourWay API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "上传 PDF",
      "request": {
        "method": "POST",
        "url": "{{base_url}}/ingest/pdf",
        "body": {
          "mode": "formdata",
          "formdata": [{"key": "file", "type": "file"}]
        }
      }
    },
    // ... 其他接口
  ]
}
```

### 可选：简单演示页面
```html
<!-- demo/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>LearnYourWay Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>LearnYourWay API 演示</h1>
    <input type="file" id="pdfFile">
    <button onclick="uploadPDF()">上传 PDF</button>
    <div id="result"></div>
    
    <script>
        async function uploadPDF() {
            const file = document.getElementById('pdfFile').files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await axios.post('http://localhost:8000/ingest/pdf', formData);
            document.getElementById('result').innerText = JSON.stringify(response.data, null, 2);
        }
    </script>
</body>
</html>
```

## 测试覆盖率目标
- 单元测试覆盖率：> 80%
- 关键路径覆盖率：100%
- API 契约测试：所有端点
- 性能测试：P95 响应时间 < 2s（正常负载）

